#!/usr/bin/env python3

import argparse
import gfail.pdl as pdl


def main(args):
    # Make PDL direcotry
    print('Preparing directory to transfer %s...'
          % args.eventid)
    pdl.prepare_pdl_directory(args.eventid)

    # Transfer
    print('Transferring...')
    log = pdl.transfer(args.eventid, args.pdl_config, dryrun=args.dry_run)
    print('done.')
    if log['rc'] is True:
        print('Successful PDL transfer.')

        # Construct URL to index.html
        url_template = ('https://dev01-earthquake.cr.usgs.gov/archive'
                        '/product/[TYPE]/[ID]/[SOURCE]/[TIME]/html/index.html')
        se_lines = log['se'].decode().split("\n")
        info_line = [l for l in se_lines if 'send complete Socket' in l][0]
        info = info_line.split(':')
        timestamp = info[-1].replace("'", "")
        eventid = info[-2]
        ptype = info[-3]
        source = info[-4]
        url = url_template.replace(
            '[TYPE]', ptype).replace(
            '[ID]', eventid).replace(
            '[SOURCE]', source).replace(
            '[TIME]', timestamp)

        # URL for event's detail feed
        feed = ('https://dev01-earthquake.cr.usgs.gov/fdsnws/event/1/'
                'query?eventid=[EVENTID]&format=geojson')
        feed = feed.replace('[EVENTID]', eventid)

        # Print to screen
        print("Web page URL:")
        print(url)
        print("Event detail JSON feed:")
        print(feed)

        # Save to file
        with open("url.txt", "w") as f:
            f.write(url)
            f.write(feed)
    else:
        print('PDL transfer failed.')

    with open("gf_transfer.log", "w") as f:
        f.write('----------------\n')
        f.write('Standard Output:\n')
        f.write('----------------\n')
        f.write(log['so'].decode())
        f.write('----------------\n')
        f.write('Standard Error:\n')
        f.write('----------------\n')
        f.write(log['se'].decode())


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        description='Transfer ground failure results to comcat.')

    parser.add_argument('eventid', help='Event id.')
    parser.add_argument('pdl_config', help='Path to PDL config.')

    parser.add_argument(
        '-d', '--dry-run', action='store_true', default=False,
        help='Dry run of pdl transfer')

    args = parser.parse_args()
    main(args)
